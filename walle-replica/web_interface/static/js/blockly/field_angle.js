/*! For license information please see index.js.LICENSE.txt */
!function(t,i){if("object"==typeof exports&&"object"==typeof module)module.exports=i(require("blockly/core"));else if("function"==typeof define&&define.amd)define(["blockly/core"],i);else{var e="object"==typeof exports?i(require("blockly/core")):i(t.Blockly);for(var s in e)("object"==typeof exports?exports:t)[s]=e[s]}}(this,(t=>(()=>{"use strict";var i={573:i=>{i.exports=t}},e={};function s(t){var o=e[t];if(void 0!==o)return o.exports;var n=e[t]={exports:{}};return i[t](n,n.exports,s),n.exports}s.d=(t,i)=>{for(var e in i)s.o(i,e)&&!s.o(t,e)&&Object.defineProperty(t,e,{enumerable:!0,get:i[e]})},s.o=(t,i)=>Object.prototype.hasOwnProperty.call(t,i),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var o={};return(()=>{s.r(o),s.d(o,{FieldAngle:()=>e,Mode:()=>t});var t,i=s(573);class e extends i.FieldNumber{constructor(t,s,o){super(i.Field.SKIP_SETUP),this.clockwise=!1,this.offset=0,this.displayMin=0,this.displayMax=360,this.minorTick=15,this.majorTick=45,this.symbol="Â°",this.boundEvents=[],this.line=null,this.gauge=null,this.symbolElement=null,t!==i.Field.SKIP_SETUP&&(o?(this.configure_(o),void 0!==o.min&&null!==o.min||this.setMin(e.DEFAULT_MIN),void 0!==o.max&&null!==o.max||this.setMax(e.DEFAULT_MAX),void 0!==o.precision&&null!==o.precision||this.setPrecision(e.DEFAULT_PRECISION)):(this.setMin(e.DEFAULT_MIN),this.setMax(e.DEFAULT_MAX),this.setPrecision(e.DEFAULT_PRECISION)),this.setValue(t),s&&this.setValidator(s))}configure_(i){switch(super.configure_(i),i.mode){case t.COMPASS:this.clockwise=!0,this.offset=90;break;case t.PROTRACTOR:this.clockwise=!1,this.offset=0}if(void 0!==i.clockwise&&(this.clockwise=i.clockwise),void 0!==i.offset&&(this.offset=i.offset),void 0!==i.displayMin&&(this.displayMin=i.displayMin),void 0!==i.displayMax&&(this.displayMax=i.displayMax),void 0!==i.minorTick&&(this.minorTick=i.minorTick),void 0!==i.majorTick&&(this.majorTick=i.majorTick),void 0!==i.symbol&&(this.symbol=i.symbol),this.displayMin>=this.displayMax)throw Error("Display min must be larger than display max");if(this.minorTick<0||this.majorTick<0)throw Error("Ticks cannot be negative")}initView(){super.initView(),this.symbol&&(this.symbolElement=i.utils.dom.createSvgElement(i.utils.Svg.TSPAN,{}),this.symbolElement.appendChild(document.createTextNode(this.symbol)),this.getTextElement().appendChild(this.symbolElement))}render_(){super.render_(),this.updateGraph()}showEditor_(t){const e=i.utils.userAgent.MOBILE||i.utils.userAgent.ANDROID||i.utils.userAgent.IPAD;super.showEditor_(t,e);const s=this.dropdownCreate();i.DropDownDiv.getContentDiv().appendChild(s);const o=this.getSourceBlock();o instanceof i.BlockSvg&&i.DropDownDiv.setColour(o.style.colourPrimary,o.style.colourTertiary),i.DropDownDiv.showPositionedByField(this,this.dropdownDispose.bind(this)),this.updateGraph()}dropdownCreate(){const t=i.utils.dom.createSvgElement(i.utils.Svg.SVG,{xmlns:i.utils.dom.SVG_NS,"xmlns:html":i.utils.dom.HTML_NS,"xmlns:xlink":i.utils.dom.XLINK_NS,version:"1.1",height:2*e.HALF+"px",width:2*e.HALF+"px"});t.style.touchAction="none";const s=i.utils.dom.createSvgElement(i.utils.Svg.CIRCLE,{cx:e.HALF,cy:e.HALF,r:e.RADIUS,class:"blocklyAngleCircle"},t);this.gauge=i.utils.dom.createSvgElement(i.utils.Svg.PATH,{class:"blocklyAngleGauge"},t),this.line=i.utils.dom.createSvgElement(i.utils.Svg.LINE,{x1:e.HALF,y1:e.HALF,class:"blocklyAngleLine"},t);const o=i.utils.math.toDegrees(this.fieldAngleToRadians(this.min_)),n=i.utils.math.toDegrees(this.fieldAngleToRadians(this.max_)),l=(s,l)=>{let r=Math.ceil(o/s)*s,a=Math.floor(n/s)*s;this.clockwise?r<a&&(r+=360):r>a&&(a+=360),a===r&&(a+=360),r>a&&([r,a]=[a,r]);for(let o=r;o<=a;o+=s)i.utils.dom.createSvgElement(i.utils.Svg.LINE,{x1:e.HALF+e.RADIUS,y1:e.HALF,x2:e.HALF+e.RADIUS-l,y2:e.HALF,class:"blocklyAngleMarks",transform:"rotate("+-o+","+e.HALF+","+e.HALF+")"},t)},r=this.displayMax-this.displayMin,a=360/r*this.minorTick;a&&l(a,5);const h=360/r*this.majorTick;return h&&l(h,10),this.boundEvents.push(i.browserEvents.conditionalBind(t,"click",this,this.hide)),this.boundEvents.push(i.browserEvents.conditionalBind(s,"pointerdown",this,this.onMouseMove_,!0)),this.boundEvents.push(i.browserEvents.conditionalBind(s,"pointermove",this,this.onMouseMove_,!0)),t}dropdownDispose(){for(const t of this.boundEvents)i.browserEvents.unbind(t);this.boundEvents.length=0,this.gauge=null,this.line=null}hide(){i.DropDownDiv.hideIfOwner(this),i.WidgetDiv.hide()}onMouseMove_(t){var i,s;const o=null===(s=null===(i=this.gauge)||void 0===i?void 0:i.ownerSVGElement)||void 0===s?void 0:s.getBoundingClientRect();if(!o)return;const n=t.clientX-o.left-e.HALF,l=t.clientY-o.top-e.HALF;let r=Math.atan2(-l,n);isNaN(r)||(r=this.radiansToFieldAngle(r),this.displayMouseOrKeyboardValue(r))}radiansToFieldAngle(t){return t/=2*Math.PI,t-=this.offset/360,this.clockwise&&(t*=-1),(t%=1)<0&&(t+=1),(t*=this.displayMax-this.displayMin)+this.displayMin}fieldAngleToRadians(t){return t-=this.displayMin,t/=this.displayMax-this.displayMin,this.clockwise&&(t*=-1),t+=this.offset/360,(t%=1)>.5&&(t-=1),t<-.5&&(t+=1),t*(2*Math.PI)}displayMouseOrKeyboardValue(t){const e=this.doClassValidation_(t);if(null!==e&&e!==this.value_){const t=this.value_;this.setEditorValue_(e,!1),this.sourceBlock_&&i.Events.isEnabled()&&this.value_!==t&&i.Events.fire(new(i.Events.get(i.Events.BLOCK_FIELD_INTERMEDIATE_CHANGE))(this.sourceBlock_,this.name||null,t,this.value_))}}updateGraph(){if(!this.gauge||!this.line)return;let t=Number(this.getText());if(isNaN(t))return;t=this.fieldAngleToRadians(t);let s=`M ${e.HALF},${e.HALF}`,o=e.HALF,n=e.HALF;if(!isNaN(t)){const l=i.utils.math.toRadians(this.offset),r=Math.cos(l)*e.RADIUS,a=Math.sin(l)*-e.RADIUS;o+=Math.cos(t)*e.RADIUS,n-=Math.sin(t)*e.RADIUS;const h=Number(this.clockwise);let d=Math.abs(Math.floor((t-l)/Math.PI)%2);h&&(d=1-d),s+=` l ${r},${a} A ${e.RADIUS},${e.RADIUS} 0 ${d} ${h} ${o},${n} z`}this.gauge.setAttribute("d",s),this.line.setAttribute("x2",`${o}`),this.line.setAttribute("y2",`${n}`)}onHtmlInputKeyDown_(t){super.onHtmlInputKeyDown_(t);const i=this.getSourceBlock();if(!i)throw new Error("The field has not yet been attached to its input. Call appendField to attach it.");let e=0;switch(t.key){case"ArrowLeft":e=i.RTL?1:-1;break;case"ArrowRight":e=i.RTL?-1:1;break;case"ArrowDown":e=-1;break;case"ArrowUp":e=1}if(e){const i=this.getValue();this.displayMouseOrKeyboardValue(i+e*this.precision_),t.preventDefault(),t.stopPropagation()}}doClassValidation_(t){if(null===t)return null;let i=Number(t);if(isNaN(i)||!isFinite(i))return null;i=this.wrapValue(i),this.precision_&&(i=Math.round(i/this.precision_)*this.precision_),i=Number(i.toFixed(10));const e=this.displayMax-this.displayMin,s=this.max_-this.min_;if(i<this.min_){const t=this.min_-i;i=t<e-t-s?this.min_:this.max_}if(i>this.max_){const t=i-this.max_;i=e-t-s<t?this.min_:this.max_}return i}wrapValue(t){const i=this.displayMax-this.displayMin;for(t%=i;t<this.displayMin;)t+=i;for(;t>=this.displayMax;)t-=i;return t}static fromJson(t){return new this(t.value,void 0,t)}}e.HALF=50,e.RADIUS=e.HALF-1,e.DEFAULT_PRECISION=15,e.DEFAULT_MIN=0,e.DEFAULT_MAX=360,i.fieldRegistry.unregister("field_angle"),i.fieldRegistry.register("field_angle",e),e.prototype.DEFAULT_VALUE=0,i.Css.register("\n.blocklyAngleCircle {\n  stroke: #444;\n  stroke-width: 1;\n  fill: #ddd;\n  fill-opacity: 0.8;\n}\n\n.blocklyAngleMarks {\n  stroke: #444;\n  stroke-width: 1;\n}\n\n.blocklyAngleGauge {\n  fill: #f88;\n  fill-opacity: 0.8;\n  pointer-events: none;\n}\n\n.blocklyAngleLine {\n  stroke: #f00;\n  stroke-width: 2;\n  stroke-linecap: round;\n  pointer-events: none;\n}\n"),function(t){t.COMPASS="compass",t.PROTRACTOR="protractor"}(t||(t={}))})(),o})()));
//# sourceMappingURL=index.js.map
